{% extends "base.html" %}

{% block title %}Server Management - PerfectMCP Admin{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-server"></i> Server Management
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-success" onclick="controlServer('start')">
                <i class="bi bi-play-fill"></i> Start Server
            </button>
            <button type="button" class="btn btn-warning" onclick="controlServer('restart')">
                <i class="bi bi-arrow-clockwise"></i> Restart Server
            </button>
            <button type="button" class="btn btn-danger" onclick="controlServer('stop')">
                <i class="bi bi-stop-fill"></i> Stop Server
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-info" onclick="refreshStatus()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="viewServerInfo()">
                <i class="bi bi-info-circle"></i> View Info
            </button>
        </div>
    </div>
</div>

<!-- Server Status Overview -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-info-circle"></i> Server Status Overview
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>MPC Server Status:</strong></td>
                                <td>
                                    <span class="status-indicator {% if server_status.running %}status-running{% else %}status-stopped{% endif %}"></span>
                                    {% if server_status.running %}Running{% else %}Stopped{% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Health Status:</strong></td>
                                <td>
                                    <span class="badge {% if server_status.health == 'healthy' %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ server_status.health|title }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Server Port:</strong></td>
                                <td><code>{{ server_status.port }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>Server URL:</strong></td>
                                <td><a href="http://192.168.0.78:{{ server_status.port }}" target="_blank">http://192.168.0.78:{{ server_status.port }}</a></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Uptime:</strong></td>
                                <td>{{ server_status.uptime or 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Admin Uptime:</strong></td>
                                <td><span id="admin-uptime">{{ "%.0f"|format(admin_uptime) }}s</span></td>
                            </tr>
                            <tr>
                                <td><strong>Last Check:</strong></td>
                                <td><span id="last-check">{{ "Just now" }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Admin Port:</strong></td>
                                <td><code>8080</code></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-success">
                    <i class="bi bi-activity"></i> Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="testConnection()">
                        <i class="bi bi-wifi"></i> Test Connection
                    </button>
                    <button class="btn btn-outline-info" onclick="viewLogs()">
                        <i class="bi bi-journal-text"></i> View Server Logs
                    </button>
                    <button class="btn btn-outline-warning" onclick="viewConfig()">
                        <i class="bi bi-gear"></i> Server Configuration
                    </button>
                    <button class="btn btn-outline-secondary" onclick="downloadLogs()">
                        <i class="bi bi-download"></i> Download Logs
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Resources -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            CPU Usage
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="cpu-usage">{{ system_stats.cpu_usage }}%</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-cpu fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Memory Usage
                        </div>
                        <div class="row no-gutters align-items-center">
                            <div class="col-auto">
                                <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">
                                    <span id="memory-usage">{{ system_stats.memory_usage }}%</span>
                                </div>
                            </div>
                            <div class="col">
                                <div class="progress progress-sm mr-2">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ system_stats.memory_usage }}%" 
                                         aria-valuenow="{{ system_stats.memory_usage }}" 
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-memory fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Disk Usage
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="disk-usage">{{ system_stats.disk_usage }}%</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-hdd fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Network Status
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="network-status">Connected</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-wifi fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Server Process Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-list-task"></i> Process Information
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Status</th>
                                <th>PID</th>
                                <th>CPU %</th>
                                <th>Memory %</th>
                                <th>Uptime</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="process-table-body">
                            <tr>
                                <td><strong>MPC Server</strong></td>
                                <td>
                                    <span class="badge {% if server_status.running %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if server_status.running %}Running{% else %}Stopped{% endif %}
                                    </span>
                                </td>
                                <td><span id="mpc-pid">{{ server_status.pid or 'N/A' }}</span></td>
                                <td><span id="mpc-cpu">0.5%</span></td>
                                <td><span id="mpc-memory">2.1%</span></td>
                                <td><span id="mpc-uptime">{{ server_status.uptime or 'N/A' }}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewProcessDetails('mpc')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Admin Interface</strong></td>
                                <td><span class="badge bg-success">Running</span></td>
                                <td><span id="admin-pid">{{ "Self" }}</span></td>
                                <td><span id="admin-cpu">0.2%</span></td>
                                <td><span id="admin-memory">1.8%</span></td>
                                <td><span id="admin-process-uptime">{{ "%.0f"|format(admin_uptime) }}s</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewProcessDetails('admin')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Server Control Panel -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-sliders"></i> Server Control Panel
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Server Commands</h6>
                        <div class="mb-3">
                            <label for="server-command" class="form-label">Custom Command:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="server-command" placeholder="Enter server command...">
                                <button class="btn btn-outline-secondary" onclick="executeCommand()">
                                    <i class="bi bi-play"></i> Execute
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Quick Commands:</label>
                            <div class="btn-group-vertical d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="executeQuickCommand('status')">
                                    Check Server Status
                                </button>
                                <button class="btn btn-outline-info" onclick="executeQuickCommand('health')">
                                    Health Check
                                </button>
                                <button class="btn btn-outline-warning" onclick="executeQuickCommand('reload')">
                                    Reload Configuration
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Command Output</h6>
                        <div class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace;">
                            <div id="command-output">
                                Ready to execute commands...<br>
                                Use the commands on the left to interact with the server.<br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Server control functions
    async function controlServer(action) {
        try {
            const response = await fetch(`/api/server/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('success', result.message);
                setTimeout(refreshStatus, 2000); // Refresh status after 2 seconds
            } else {
                showAlert('danger', result.message);
            }
        } catch (error) {
            showAlert('danger', `Error: ${error.message}`);
        }
    }

    // Refresh server status
    async function refreshStatus() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            
            // Update status indicators
            updateServerStatus(data.mpc_server);
            updateSystemMetrics(data.system);
            
            document.getElementById('last-check').textContent = new Date().toLocaleTimeString();
            showAlert('info', 'Status refreshed');
        } catch (error) {
            showAlert('danger', `Error refreshing status: ${error.message}`);
        }
    }

    // Test server connection
    async function testConnection() {
        try {
            const response = await fetch('http://192.168.0.78:8000/health');
            if (response.ok) {
                const data = await response.json();
                showAlert('success', `Connection successful! Server status: ${data.status}`);
            } else {
                showAlert('warning', `Connection failed with HTTP ${response.status}`);
            }
        } catch (error) {
            showAlert('danger', `Connection test failed: ${error.message}`);
        }
    }

    // View logs
    function viewLogs() {
        window.location.href = '/logs';
    }

    // View configuration
    function viewConfig() {
        window.location.href = '/config';
    }

    // Download logs
    function downloadLogs() {
        showAlert('info', 'Preparing log download...');
        // Mock download functionality
        setTimeout(() => {
            showAlert('success', 'Logs downloaded successfully');
        }, 1000);
    }

    // Execute custom command
    async function executeCommand() {
        const command = document.getElementById('server-command').value.trim();
        if (!command) {
            showAlert('warning', 'Please enter a command');
            return;
        }
        
        appendToOutput(`> ${command}`);
        
        // Mock command execution
        setTimeout(() => {
            appendToOutput(`Command executed: ${command}`);
            appendToOutput('Output: Command completed successfully');
        }, 500);
        
        document.getElementById('server-command').value = '';
    }

    // Execute quick command
    function executeQuickCommand(type) {
        let command = '';
        switch(type) {
            case 'status':
                command = 'curl http://192.168.0.78:8000/api/status';
                break;
            case 'health':
                command = 'curl http://192.168.0.78:8000/health';
                break;
            case 'reload':
                command = 'systemctl reload perfectmpc';
                break;
        }
        
        appendToOutput(`> ${command}`);
        
        // Mock execution
        setTimeout(() => {
            appendToOutput(`${type} check completed successfully`);
        }, 500);
    }

    // Append text to command output
    function appendToOutput(text) {
        const output = document.getElementById('command-output');
        output.innerHTML += text + '<br>';
        output.scrollTop = output.scrollHeight;
    }

    // View process details
    function viewProcessDetails(processType) {
        showAlert('info', `Viewing ${processType} process details...`);
        // This would open a modal with detailed process information
    }

    // Update server status
    function updateServerStatus(status) {
        // Update status indicators and information
        const indicators = document.querySelectorAll('.status-indicator');
        indicators.forEach(indicator => {
            if (status.running) {
                indicator.className = 'status-indicator status-running';
            } else {
                indicator.className = 'status-indicator status-stopped';
            }
        });
    }

    // Update system metrics
    function updateSystemMetrics(metrics) {
        document.getElementById('cpu-usage').textContent = `${metrics.cpu_usage}%`;
        document.getElementById('memory-usage').textContent = `${metrics.memory_usage}%`;
        document.getElementById('disk-usage').textContent = `${metrics.disk_usage}%`;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Update admin uptime every second
        setInterval(() => {
            const uptimeElement = document.getElementById('admin-uptime');
            if (uptimeElement) {
                const currentUptime = parseInt(uptimeElement.textContent);
                uptimeElement.textContent = `${currentUptime + 1}s`;
            }
        }, 1000);

        // Auto-refresh status every 30 seconds
        setInterval(refreshStatus, 30000);
    });

    // View server info
    async function viewServerInfo() {
        try {
            // Fetch comprehensive server information
            const response = await fetch('/api/status');
            const data = await response.json();

            if (!data.success) {
                showAlert('danger', 'Failed to fetch server information');
                return;
            }

            // Create server info modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'serverInfoModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-info-circle"></i> Server Information
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-server"></i> MCP Server</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Status:</strong></td>
                                            <td><span class="badge \${data.mcp_server?.running ? 'bg-success' : 'bg-danger'}">\${data.mcp_server?.running ? 'Running' : 'Stopped'}</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Health:</strong></td>
                                            <td>\${data.mcp_server?.health || 'Unknown'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Uptime:</strong></td>
                                            <td>\${formatUptime(data.admin_uptime || 0)}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Version:</strong></td>
                                            <td>1.0.0</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="bi bi-cpu"></i> System Resources</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>CPU Usage:</strong></td>
                                            <td>\${data.system?.cpu_percent || 0}%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Memory Usage:</strong></td>
                                            <td>\${data.system?.memory_percent || 0}%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Disk Usage:</strong></td>
                                            <td>\${data.system?.disk_percent || 0}%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Load Average:</strong></td>
                                            <td>\${data.system?.load_average || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-database"></i> Database Status</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Redis:</strong></td>
                                            <td><span class="badge \${data.databases?.redis ? 'bg-success' : 'bg-danger'}">\${data.databases?.redis ? 'Connected' : 'Disconnected'}</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>MongoDB:</strong></td>
                                            <td><span class="badge \${data.databases?.mongodb ? 'bg-success' : 'bg-danger'}">\${data.databases?.mongodb ? 'Connected' : 'Disconnected'}</span></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="bi bi-gear"></i> Services Status</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            \${Object.entries(data.services || {}).map(([service, status]) => \`
                                                <tr>
                                                    <td><strong>\${service.replace('_', ' ').replace(/\\b\\w/g, l => l.toUpperCase())}:</strong></td>
                                                    <td><span class="badge \${status ? 'bg-success' : 'bg-secondary'}">\${status ? 'Active' : 'Inactive'}</span></td>
                                                </tr>
                                            \`).join('')}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-primary" onclick="refreshServerInfo()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // Clean up when modal is hidden
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });

        } catch (error) {
            console.error('Error fetching server info:', error);
            showAlert('danger', \`Failed to fetch server information: \${error.message}\`);
        }
    }

    // Format uptime helper function
    function formatUptime(seconds) {
        if (!seconds || seconds < 0) return "0s";

        const years = Math.floor(seconds / (365 * 24 * 3600));
        const days = Math.floor((seconds % (365 * 24 * 3600)) / (24 * 3600));
        const hours = Math.floor((seconds % (24 * 3600)) / 3600);
        const secs = Math.floor(seconds % 3600);

        let parts = [];

        if (years > 0) parts.push(\`\${years}y\`);
        if (days > 0) parts.push(\`\${days}d\`);
        if (hours > 0) parts.push(\`\${hours}h\`);
        if (secs > 0 || parts.length === 0) parts.push(\`\${secs}s\`);

        return parts.slice(0, 3).join(' ');
    }
</script>
{% endblock %}
