{% extends "base.html" %}

{% block title %}Dashboard - PerfectMCP Admin{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced progress bars for system metrics */
    .metric-card .progress {
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .metric-card .progress-bar {
        transition: width 0.6s ease;
        border-radius: 4px;
    }

    /* Progress bar color variations based on usage levels */
    .progress-bar.bg-success {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    }

    .progress-bar.bg-info {
        background: linear-gradient(90deg, #17a2b8 0%, #6f42c1 100%);
    }

    .progress-bar.bg-warning {
        background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
    }

    /* High usage warning colors */
    .progress-bar.high-usage {
        background: linear-gradient(90deg, #dc3545 0%, #e74c3c 100%) !important;
        animation: pulse-warning 2s infinite;
    }

    @keyframes pulse-warning {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .metric-card .progress {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* Custom column widths for 35%/65% split */
    @media (min-width: 992px) {
        .col-xl-35 {
            flex: 0 0 35%;
            max-width: 35%;
        }

        .col-xl-65 {
            flex: 0 0 65%;
            max-width: 65%;
        }
    }

    /* Ensure equal height cards */
    .equal-height-row {
        display: flex;
        flex-wrap: wrap;
    }

    .equal-height-row > [class*="col-"] {
        display: flex;
        flex-direction: column;
    }

    .equal-height-row .card {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .equal-height-row .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
</style>
{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-speedometer2"></i> Dashboard
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-success" onclick="controlServer('start')" title="Start MCP Core Server (Port 8000)">
                <i class="bi bi-play-fill"></i> Start MCP
            </button>
            <button type="button" class="btn btn-warning" onclick="controlServer('restart')" title="Restart MCP Core Server (Port 8000)">
                <i class="bi bi-arrow-clockwise"></i> Restart MCP
            </button>
            <button type="button" class="btn btn-danger" onclick="controlServer('stop')" title="Stop MCP Core Server (Port 8000)">
                <i class="bi bi-stop-fill"></i> Stop MCP
            </button>
        </div>
        <div class="btn-group me-2">
            <a href="/maintenance" class="btn btn-outline-info" title="Database cleanup and maintenance tasks">
                <i class="bi bi-tools"></i> Maintenance
            </a>
        </div>
    </div>
</div>

<!-- Server Status Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            MCP Server Status
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span class="status-indicator {% if server_status.running %}status-running{% else %}status-stopped{% endif %}"></span>
                            {% if server_status.running %}Running{% else %}Stopped{% endif %}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-server fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            CPU Usage
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="cpu-usage">{{ system_stats.cpu_usage }}%</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                 id="cpu-progress-bar"
                                 style="width: {{ system_stats.cpu_usage }}%"
                                 aria-valuenow="{{ system_stats.cpu_usage }}"
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-cpu fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Memory Usage
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="memory-usage">{{ system_stats.memory_usage }}%</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-info" role="progressbar"
                                 id="memory-progress-bar"
                                 style="width: {{ system_stats.memory_usage }}%"
                                 aria-valuenow="{{ system_stats.memory_usage }}"
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-memory fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Disk Usage
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            <span id="disk-usage">{{ system_stats.disk_usage }}%</span>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar"
                                 id="disk-progress-bar"
                                 style="width: {{ system_stats.disk_usage }}%"
                                 aria-valuenow="{{ system_stats.disk_usage }}"
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-hdd fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Server Information -->
<div class="row mb-4 equal-height-row">
    <div class="col-lg-4 col-xl-35">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-info-circle"></i> Server Information
                </h6>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td>
                            <span class="status-indicator {% if server_status.running %}status-running{% else %}status-stopped{% endif %}"></span>
                            {% if server_status.running %}Running{% else %}Stopped{% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Health:</strong></td>
                        <td>{{ server_status.health|title }}</td>
                    </tr>
                    <tr>
                        <td><strong>Port:</strong></td>
                        <td>{{ server_status.port }}</td>
                    </tr>
                    <tr>
                        <td><strong>Uptime:</strong></td>
                        <td>{{ server_status.uptime or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <td><strong>Admin Uptime:</strong></td>
                        <td><span id="admin-uptime">Loading...</span></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-8 col-xl-65">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-hdd-network"></i> Most Active Host
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-5">
                        <div class="d-flex align-items-center justify-content-center" style="height: 250px;">
                            <canvas id="hostChart" width="300" height="200"></canvas>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0" id="host-activity-table">
                                <thead>
                                    <tr>
                                        <th>IP Address</th>
                                        <th>Hostname</th>
                                        <th>GET</th>
                                        <th>POST</th>
                                        <th>PUT</th>
                                        <th>Total</th>
                                        <th>Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody id="host-activity-tbody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Loading host activity data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="/sessions" class="btn btn-outline-primary btn-block w-100">
                            <i class="bi bi-collection"></i><br>
                            Manage Sessions
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/documents" class="btn btn-outline-success btn-block w-100">
                            <i class="bi bi-file-earmark-text"></i><br>
                            Upload Documents
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/database" class="btn btn-outline-info btn-block w-100">
                            <i class="bi bi-database"></i><br>
                            Browse Database
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/logs" class="btn btn-outline-warning btn-block w-100">
                            <i class="bi bi-journal-text"></i><br>
                            View Logs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-clock-history"></i> Recent Activity
                </h6>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <p class="text-muted">Loading recent activity...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize host activity chart
    const hostCtx = document.getElementById('hostChart').getContext('2d');
    let hostChart = new Chart(hostCtx, {
        type: 'doughnut',
        data: {
            labels: ['Loading...'],
            datasets: [{
                data: [1],
                backgroundColor: ['#6c757d'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Total Requests by Host'
                }
            }
        }
    });

    // Update system metrics (progress bars only)
    function updateSystemMetrics(metrics) {
        // Update text values
        document.getElementById('cpu-usage').textContent = `${metrics.cpu_usage}%`;
        document.getElementById('memory-usage').textContent = `${metrics.memory_usage}%`;
        document.getElementById('disk-usage').textContent = `${metrics.disk_usage}%`;

        // Update progress bars with dynamic styling
        updateProgressBar('cpu-progress-bar', metrics.cpu_usage, 'bg-success');
        updateProgressBar('memory-progress-bar', metrics.memory_usage, 'bg-info');
        updateProgressBar('disk-progress-bar', metrics.disk_usage, 'bg-warning');
    }

    // Update host chart with activity data
    function updateHostChart(hosts) {
        if (!hosts || hosts.length === 0) return;

        // Sort hosts by total requests and take top 5
        const topHosts = hosts.sort((a, b) => b.total_requests - a.total_requests).slice(0, 5);

        const labels = topHosts.map(host => `${host.ip_address}\n(${host.hostname})`);
        const data = topHosts.map(host => host.total_requests);
        const colors = [
            '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'
        ];

        hostChart.data.labels = labels;
        hostChart.data.datasets[0].data = data;
        hostChart.data.datasets[0].backgroundColor = colors.slice(0, data.length);
        hostChart.update();
    }

    // Helper function to update progress bars with warning colors
    function updateProgressBar(elementId, value, baseClass) {
        const progressBar = document.getElementById(elementId);
        if (progressBar) {
            progressBar.style.width = `${value}%`;
            progressBar.setAttribute('aria-valuenow', value);

            // Remove existing classes
            progressBar.classList.remove('high-usage', 'bg-success', 'bg-info', 'bg-warning');

            // Add warning class for high usage (>85%)
            if (value > 85) {
                progressBar.classList.add('high-usage');
            } else {
                progressBar.classList.add(baseClass);
            }
        }
    }

    // Format uptime in Y:D:H:M:S format
    function formatUptime(seconds) {
        if (!seconds || seconds < 0) return "0:00";

        const years = Math.floor(seconds / (365 * 24 * 3600));
        const days = Math.floor((seconds % (365 * 24 * 3600)) / (24 * 3600));
        const hours = Math.floor((seconds % (24 * 3600)) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);

        let result = "";

        if (years > 0) {
            result += `${years}Y `;
        }
        if (days > 0 || years > 0) {
            result += `${days}D `;
        }
        if (hours > 0 || days > 0 || years > 0) {
            result += `${hours}H `;
        }
        if (minutes > 0 || hours > 0 || days > 0 || years > 0) {
            result += `${minutes}M `;
        }
        result += `${secs}S`;

        return result.trim();
    }

    // Load recent activity
    async function loadRecentActivity() {
        try {
            const response = await fetch('/api/activity/recent');
            const activities = await response.json();
            
            const container = document.getElementById('recent-activity');
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-muted">No recent activity</p>';
                return;
            }
            
            let html = '<div class="list-group">';
            activities.forEach(activity => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${activity.title}</h6>
                            <small>${activity.timestamp}</small>
                        </div>
                        <p class="mb-1">${activity.description}</p>
                        <small class="text-muted">${activity.type}</small>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading recent activity:', error);
            document.getElementById('recent-activity').innerHTML = 
                '<p class="text-danger">Error loading recent activity</p>';
        }
    }

    // Fetch real-time system metrics
    async function fetchSystemMetrics() {
        try {
            const response = await fetch('/api/system/metrics');
            if (response.ok) {
                const metrics = await response.json();
                updateSystemMetrics(metrics);
            }
        } catch (error) {
            console.error('Error fetching system metrics:', error);
        }
    }

    // Load host activity data
    async function loadHostActivity() {
        try {
            const response = await fetch('/api/host/activity');
            if (response.ok) {
                const data = await response.json();
                const hosts = data.hosts || [];
                updateHostActivityTable(hosts);
                updateHostChart(hosts);
            } else {
                updateHostActivityTable([]);
                updateHostChart([]);
            }
        } catch (error) {
            console.error('Error loading host activity:', error);
            updateHostActivityTable([]);
            updateHostChart([]);
        }
    }

    // Update host activity table
    function updateHostActivityTable(hosts) {
        const tbody = document.getElementById('host-activity-tbody');

        if (hosts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No host activity data available</td></tr>';
            return;
        }

        // Sort hosts by total requests (descending)
        hosts.sort((a, b) => b.total_requests - a.total_requests);

        let html = '';
        hosts.forEach((host, index) => {
            const rowClass = index === 0 ? 'table-success' : ''; // Highlight most active host
            html += `
                <tr class="${rowClass}">
                    <td><strong>${host.ip_address}</strong></td>
                    <td>${host.hostname || 'Unknown'}</td>
                    <td><span class="badge badge-info">${host.get_requests}</span></td>
                    <td><span class="badge badge-warning">${host.post_requests}</span></td>
                    <td><span class="badge badge-success">${host.put_requests}</span></td>
                    <td><strong>${host.total_requests}</strong></td>
                    <td><small>${formatLastActivity(host.last_activity)}</small></td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    // Format last activity time
    function formatLastActivity(timestamp) {
        if (!timestamp) return 'Never';

        const now = new Date();
        const activity = new Date(timestamp);
        const diffMs = now - activity;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;

        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h ago`;

        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d ago`;
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        loadRecentActivity();
        loadHostActivity();

        // Initialize and update admin uptime every second with proper formatting
        let adminStartTime = Date.now() / 1000 - {{ admin_uptime }};

        // Set initial uptime
        const uptimeElement = document.getElementById('admin-uptime');
        if (uptimeElement) {
            uptimeElement.textContent = formatUptime({{ admin_uptime }});
        }

        // Update every second
        setInterval(() => {
            if (uptimeElement) {
                const currentUptime = Date.now() / 1000 - adminStartTime;
                uptimeElement.textContent = formatUptime(currentUptime);
            }
        }, 1000);

        // Update system metrics every 5 seconds
        setInterval(fetchSystemMetrics, 5000);

        // Update host activity every 30 seconds
        setInterval(loadHostActivity, 30000);
    });
</script>
{% endblock %}
