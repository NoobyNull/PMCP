{% extends "base.html" %}

{% block title %}Database - PerfectMPC Admin{% endblock %}

{% block extra_head %}
<style>
    .key-value-display {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }
    .collection-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .collection-item:hover {
        background-color: #e9ecef;
    }
    .collection-item.active {
        background-color: #007bff;
        color: white;
    }

    /* Dark mode fixes for database tabs */
    [data-theme="dark"] .nav-tabs .nav-link {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: #ffffff !important;
    }

    [data-theme="dark"] .nav-tabs .nav-link.active {
        background-color: var(--card-bg);
        border-color: var(--border-color);
        color: #ffffff !important;
    }

    [data-theme="dark"] .nav-tabs .nav-link:hover {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: #ffffff !important;
    }

    [data-theme="dark"] .key-value-display {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: #ffffff;
    }

    [data-theme="dark"] .collection-item {
        background-color: var(--bg-secondary);
        border-color: var(--border-color);
        color: #ffffff;
    }

    [data-theme="dark"] .collection-item:hover {
        background-color: #495057;
    }

    [data-theme="dark"] .collection-item.active {
        background-color: #007bff;
        color: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-database"></i> Database Administration
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-primary" onclick="refreshDatabases()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button type="button" class="btn btn-outline-success" onclick="backupDatabases()">
                <i class="bi bi-download"></i> Backup
            </button>
        </div>
    </div>
</div>

<!-- Database Status Cards -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-left-primary shadow h-100">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-hdd-rack"></i> Redis Status
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Connection</div>
                        <div class="h6 mb-0" id="redis-status">
                            <span class="status-indicator status-unknown"></span> Checking...
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Keys</div>
                        <div class="h6 mb-0" id="redis-keys-count">0</div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Memory</div>
                        <div class="h6 mb-0" id="redis-memory">0 MB</div>
                    </div>
                    <div class="col-6">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Uptime</div>
                        <div class="h6 mb-0" id="redis-uptime">0s</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card border-left-success shadow h-100">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-success">
                    <i class="bi bi-database"></i> MongoDB Status
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Connection</div>
                        <div class="h6 mb-0" id="mongodb-status">
                            <span class="status-indicator status-unknown"></span> Checking...
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Collections</div>
                        <div class="h6 mb-0" id="mongodb-collections-count">0</div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Total Records</div>
                        <div class="h6 mb-0" id="mongodb-documents-count">0</div>
                        <small class="text-muted">All collections</small>
                    </div>
                    <div class="col-6">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Size</div>
                        <div class="h6 mb-0" id="mongodb-size">0 MB</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Database Tabs -->
<ul class="nav nav-tabs" id="database-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="redis-tab" data-bs-toggle="tab" data-bs-target="#redis-panel" type="button" role="tab">
            <i class="bi bi-hdd-rack"></i> Redis Browser
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="mongodb-tab" data-bs-toggle="tab" data-bs-target="#mongodb-panel" type="button" role="tab">
            <i class="bi bi-database"></i> MongoDB Browser
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup-panel" type="button" role="tab">
            <i class="bi bi-archive"></i> Backup & Restore
        </button>
    </li>
</ul>

<div class="tab-content" id="database-tab-content">
    <!-- Redis Panel -->
    <div class="tab-pane fade show active" id="redis-panel" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="m-0">Redis Key Browser</h6>
                    </div>
                    <div class="col-auto">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="redis-pattern" placeholder="Key pattern (e.g., mpc:*)" value="*">
                            <button class="btn btn-outline-secondary" onclick="loadRedisKeys()">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Type</th>
                                <th>TTL</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="redis-keys-tbody">
                            <tr>
                                <td colspan="4" class="text-center">Loading keys...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MongoDB Panel -->
    <div class="tab-pane fade" id="mongodb-panel" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0">MongoDB Collection Browser</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Collections</h6>
                        <div class="list-group" id="mongodb-collections-list">
                            <div class="list-group-item">Loading collections...</div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h6>Documents <span id="selected-collection-name"></span></h6>
                        <div id="mongodb-documents-container">
                            <p class="text-muted">Select a collection to view documents</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Panel -->
    <div class="tab-pane fade" id="backup-panel" role="tabpanel">
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0">Database Backup & Restore</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Create Backup</h6>
                        <div class="mb-3">
                            <label class="form-label">Backup Type</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="backup-redis" checked>
                                <label class="form-check-label" for="backup-redis">Redis</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="backup-mongodb" checked>
                                <label class="form-check-label" for="backup-mongodb">MongoDB</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="bi bi-download"></i> Create Backup
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Available Backups</h6>
                        <div id="backup-list">
                            <p class="text-muted">Loading backups...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Redis Key Details Modal -->
<div class="modal fade" id="redisKeyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Redis Key Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="redis-key-details">
                <!-- Key details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="delete-redis-key-btn">Delete Key</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let redisKeys = [];
    let mongoCollections = [];
    let currentRedisKey = null;

    // Load Redis keys
    async function loadRedisKeys() {
        const pattern = document.getElementById('redis-pattern').value || '*';

        try {
            const response = await fetch(`/api/database/redis/keys?pattern=${encodeURIComponent(pattern)}`);
            const data = await response.json();

            if (data.error) {
                showAlert('warning', `Error loading Redis keys: ${data.error}`);
                redisKeys = [];
            } else {
                redisKeys = data.keys || [];
            }

            updateRedisKeysTable();

        } catch (error) {
            console.error('Error loading Redis keys:', error);
            showAlert('danger', `Error loading Redis keys: ${error.message}`);
            redisKeys = [];
            updateRedisKeysTable();
        }
    }

    // Update Redis keys table
    function updateRedisKeysTable() {
        const tbody = document.getElementById('redis-keys-tbody');
        
        if (redisKeys.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No keys found</td></tr>';
            return;
        }
        
        let html = '';
        redisKeys.forEach(key => {
            const ttlText = key.ttl === -1 ? 'No expiry' : key.ttl === -2 ? 'Expired' : `${key.ttl}s`;
            
            html += `
                <tr>
                    <td><code>${key.key}</code></td>
                    <td><span class="badge bg-secondary">${key.type}</span></td>
                    <td>${ttlText}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewRedisKey('${key.key}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRedisKey('${key.key}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        
        // Update count
        document.getElementById('redis-keys-count').textContent = redisKeys.length;
    }

    // Load MongoDB collections
    async function loadMongoCollections() {
        try {
            const response = await fetch('/api/database/mongodb/collections');
            const data = await response.json();

            if (data.error) {
                showAlert('warning', `Error loading MongoDB collections: ${data.error}`);
                mongoCollections = [];
            } else {
                mongoCollections = data.collections || [];
            }

            updateMongoCollectionsList();

        } catch (error) {
            console.error('Error loading MongoDB collections:', error);
            showAlert('danger', `Error loading MongoDB collections: ${error.message}`);
            mongoCollections = [];
            updateMongoCollectionsTable();
        }
    }

    // Update MongoDB collections list
    function updateMongoCollectionsList() {
        const list = document.getElementById('mongodb-collections-list');

        if (mongoCollections.length === 0) {
            list.innerHTML = '<div class="list-group-item text-muted">No collections found</div>';
            return;
        }

        // Separate document collections from other data collections
        const documentCollections = mongoCollections.filter(col =>
            col.name.includes('document') || col.name.includes('rag') || col.name.includes('embedding')
        );
        const otherCollections = mongoCollections.filter(col =>
            !col.name.includes('document') && !col.name.includes('rag') && !col.name.includes('embedding')
        );

        let html = '';

        // Document collections section
        if (documentCollections.length > 0) {
            html += '<div class="list-group-item bg-light"><strong>📄 Document Collections</strong></div>';
            documentCollections.forEach(collection => {
                html += `
                    <a href="#" class="list-group-item list-group-item-action" onclick="selectCollection('${collection.name}')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${collection.name}</h6>
                            <small class="text-primary">${collection.count} docs</small>
                        </div>
                        <p class="mb-1">Size: ${(collection.size / 1024).toFixed(1)} KB</p>
                    </a>
                `;
            });
        }

        // Other collections section
        if (otherCollections.length > 0) {
            html += '<div class="list-group-item bg-light"><strong>🗃️ System Collections</strong></div>';
            otherCollections.forEach(collection => {
                html += `
                    <a href="#" class="list-group-item list-group-item-action" onclick="selectCollection('${collection.name}')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${collection.name}</h6>
                            <small class="text-secondary">${collection.count} records</small>
                        </div>
                        <p class="mb-1">Size: ${(collection.size / 1024).toFixed(1)} KB</p>
                    </a>
                `;
            });
        }

        list.innerHTML = html;

        // Update count
        document.getElementById('mongodb-collections-count').textContent = mongoCollections.length;

        const totalDocs = mongoCollections.reduce((sum, col) => sum + col.count, 0);
        const documentCount = documentCollections.reduce((sum, col) => sum + col.count, 0);

        // Show total records with breakdown
        document.getElementById('mongodb-documents-count').innerHTML = `
            ${totalDocs}
            <br><small class="text-muted">${documentCount} docs, ${totalDocs - documentCount} system</small>
        `;

        const totalSize = mongoCollections.reduce((sum, col) => sum + col.size, 0);
        document.getElementById('mongodb-size').textContent = `${(totalSize / 1024 / 1024).toFixed(1)} MB`;
    }

    // View Redis key details
    async function viewRedisKey(keyName) {
        currentRedisKey = keyName;
        
        // Mock implementation - in real version, fetch key value
        const keyDetails = document.getElementById('redis-key-details');
        keyDetails.innerHTML = `
            <div class="mb-3">
                <label class="form-label"><strong>Key:</strong></label>
                <code>${keyName}</code>
            </div>
            <div class="mb-3">
                <label class="form-label"><strong>Value:</strong></label>
                <textarea class="form-control" rows="10" readonly>Loading value...</textarea>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('redisKeyModal')).show();
    }

    // Delete Redis key
    async function deleteRedisKey(keyName) {
        if (!confirm(`Are you sure you want to delete key "${keyName}"?`)) {
            return;
        }
        
        // Mock implementation
        showAlert('success', `Key "${keyName}" deleted successfully`);
        loadRedisKeys();
    }

    // Select MongoDB collection
    function selectCollection(collectionName) {
        document.getElementById('selected-collection-name').textContent = `(${collectionName})`;
        
        // Mock implementation - load documents
        const container = document.getElementById('mongodb-documents-container');
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>_id</th>
                            <th>Document</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="text-center">Loading documents...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
    }

    // Refresh databases
    function refreshDatabases() {
        loadRedisKeys();
        loadMongoCollections();
        checkDatabaseStatus();
    }

    // Check database status
    async function checkDatabaseStatus() {
        // Mock implementation
        document.getElementById('redis-status').innerHTML = 
            '<span class="status-indicator status-running"></span> Connected';
        document.getElementById('mongodb-status').innerHTML = 
            '<span class="status-indicator status-running"></span> Connected';
    }

    // Create backup
    async function createBackup() {
        const includeRedis = document.getElementById('backup-redis').checked;
        const includeMongoDB = document.getElementById('backup-mongodb').checked;

        if (!includeRedis && !includeMongoDB) {
            showAlert('warning', 'Please select at least one database to backup');
            return;
        }

        showAlert('info', 'Creating backup... This may take a few minutes.');

        try {
            const response = await fetch('/api/database/backup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    include_redis: includeRedis,
                    include_mongodb: includeMongoDB
                })
            });

            const result = await response.json();

            if (result.success) {
                showAlert('success', result.message);
                loadBackups(); // Refresh backup list
            } else {
                showAlert('danger', `Backup failed: ${result.error}`);
            }

        } catch (error) {
            console.error('Backup error:', error);
            showAlert('danger', `Backup failed: ${error.message}`);
        }
    }

    // Load available backups
    async function loadBackups() {
        try {
            const response = await fetch('/api/database/backups');
            const data = await response.json();

            if (data.error) {
                console.error('Error loading backups:', data.error);
                document.getElementById('backup-list').innerHTML = '<p class="text-muted">Error loading backups</p>';
                return;
            }

            const backups = data.backups || [];
            updateBackupsList(backups);

        } catch (error) {
            console.error('Error loading backups:', error);
            document.getElementById('backup-list').innerHTML = '<p class="text-muted">Error loading backups</p>';
        }
    }

    // Update backups list
    function updateBackupsList(backups) {
        const container = document.getElementById('backup-list');

        if (backups.length === 0) {
            container.innerHTML = '<p class="text-muted">No backups found</p>';
            return;
        }

        let html = '<div class="list-group">';
        backups.forEach(backup => {
            const size = formatFileSize(backup.size);
            const created = new Date(backup.created).toLocaleString();

            html += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${backup.type.toUpperCase()} - ${backup.filename}</h6>
                        <small>${created}</small>
                    </div>
                    <p class="mb-1">Size: ${size}</p>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="downloadBackup('${backup.path}')">
                            <i class="bi bi-download"></i> Download
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteBackup('${backup.path}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadRedisKeys();
        loadMongoCollections();
        checkDatabaseStatus();
        loadBackups();
    });
</script>
{% endblock %}
