{% extends "base.html" %}

{% block title %}MCP Server Status - PerfectMPC Admin{% endblock %}

{% block extra_head %}
<style>
    .status-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        background-color: var(--card-bg);
    }
    .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    /* Smooth transitions for status updates - NO FLASH */
    #servers-container, #no-servers, #loading-state {
        transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
    }

    .server-item {
        transition: all 0.3s ease-in-out;
    }

    /* Prevent flash during transitions */
    .fade-out {
        opacity: 0;
        visibility: hidden;
    }

    .fade-in {
        opacity: 1;
        visibility: visible;
    }

    .hidden {
        display: none !important;
    }
    
    .server-status {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .status-running {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .status-stopped {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .status-error {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .status-unknown {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }
    
    [data-theme="dark"] .status-running {
        background-color: #1e4620;
        color: #4caf50;
        border: 1px solid #2e7d32;
    }
    
    [data-theme="dark"] .status-stopped {
        background-color: #4a1e1e;
        color: #f44336;
        border: 1px solid #d32f2f;
    }
    
    [data-theme="dark"] .status-error {
        background-color: #4a3c1e;
        color: #ff9800;
        border: 1px solid #f57c00;
    }
    
    [data-theme="dark"] .status-unknown {
        background-color: #3a3a3a;
        color: #9e9e9e;
        border: 1px solid #616161;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Ensure all text is white in dark mode */
    [data-theme="dark"] .metric-label,
    [data-theme="dark"] .card-body small,
    [data-theme="dark"] .card-body .text-muted,
    [data-theme="dark"] .server-item small,
    [data-theme="dark"] .server-item .metric-label,
    [data-theme="dark"] .status-card small,
    [data-theme="dark"] .status-card .metric-label {
        color: #ffffff !important;
    }
    
    .tool-badge {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
        border-radius: 0.2rem;
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        margin: 0.1rem;
        display: inline-block;
    }
    
    .filter-controls {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .search-input {
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
    }
    
    .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background-color: var(--input-bg);
        color: var(--text-primary);
    }
    
    .filter-btn {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
        margin: 0.25rem;
        transition: all 0.2s;
    }
    
    .filter-btn:hover, .filter-btn.active {
        background-color: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .uptime-indicator {
        height: 4px;
        background: linear-gradient(90deg, #28a745 0%, #ffc107 70%, #dc3545 100%);
        border-radius: 2px;
        margin-top: 0.5rem;
    }
    
    .response-time-chart {
        height: 60px;
        background: var(--bg-secondary);
        border-radius: 0.25rem;
        position: relative;
        overflow: hidden;
    }

    /* Additional dark mode text fixes */
    [data-theme="dark"] .card-header h6,
    [data-theme="dark"] .card-header .mb-0,
    [data-theme="dark"] .card-body div,
    [data-theme="dark"] .card-body span,
    [data-theme="dark"] .card-text,
    [data-theme="dark"] .metric-value,
    [data-theme="dark"] .tool-badge,
    [data-theme="dark"] label,
    [data-theme="dark"] .form-label,
    [data-theme="dark"] .btn-group .btn,
    [data-theme="dark"] .d-flex small,
    [data-theme="dark"] .justify-content-between small {
        color: #ffffff !important;
    }

    /* Fix specific elements that might still be dark */
    [data-theme="dark"] * {
        color: inherit;
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .card-body,
    [data-theme="dark"] .card-header {
        color: #ffffff;
    }

    /* Modal backdrop fix - ensure proper z-index and cleanup */
    .modal {
        z-index: 1055;
    }

    .modal-backdrop {
        z-index: 1050;
        background-color: rgba(0, 0, 0, 0.5);
    }

    [data-theme="dark"] .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.7);
    }

    /* Ensure modal content is above backdrop */
    .modal-dialog {
        z-index: 1060;
        position: relative;
    }

    /* Fix modal content in dark mode */
    [data-theme="dark"] .modal-content {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        color: #ffffff;
    }

    [data-theme="dark"] .modal-header,
    [data-theme="dark"] .modal-body,
    [data-theme="dark"] .modal-footer {
        border-color: var(--border-color);
        color: #ffffff;
    }
</style>
{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-server"></i> MCP Server Status
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary me-2" onclick="refreshStatus()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="exportMetrics()">
            <i class="bi bi-download"></i> Export
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card status-card h-100">
            <div class="card-body text-center">
                <div class="metric-value text-success" id="running-count">0</div>
                <div class="metric-label">Running Servers</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card status-card h-100">
            <div class="card-body text-center">
                <div class="metric-value text-primary" id="total-tools">0</div>
                <div class="metric-label">Available Tools</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card status-card h-100">
            <div class="card-body text-center">
                <div class="metric-value text-info" id="total-calls">0</div>
                <div class="metric-label">Total Tool Calls</div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card status-card h-100">
            <div class="card-body text-center">
                <div class="metric-value text-warning" id="avg-response">0ms</div>
                <div class="metric-label">Avg Response Time</div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="filter-controls">
    <div class="row">
        <div class="col-md-6">
            <input type="text" class="form-control search-input" id="server-search" 
                   placeholder="Search servers by name or tool..." onkeyup="filterServers()">
        </div>
        <div class="col-md-6">
            <select class="form-select" id="sort-select" onchange="sortServers()">
                <option value="name">Sort by Name</option>
                <option value="status">Sort by Status</option>
                <option value="uptime">Sort by Uptime</option>
                <option value="activity">Sort by Activity</option>
                <option value="response_time">Sort by Response Time</option>
            </select>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-12">
            <div class="d-flex flex-wrap">
                <button class="filter-btn active" data-status="all" onclick="filterByStatus('all')">All</button>
                <button class="filter-btn" data-status="running" onclick="filterByStatus('running')">Running</button>
                <button class="filter-btn" data-status="stopped" onclick="filterByStatus('stopped')">Stopped</button>
                <button class="filter-btn" data-status="error" onclick="filterByStatus('error')">Error</button>
                <button class="filter-btn" data-status="unknown" onclick="filterByStatus('unknown')">Unknown</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="loading-state" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading MCP servers...</span>
    </div>
    <p class="mt-3 text-muted">Checking MCP server status...</p>
</div>

<!-- Server Status Grid -->
<div id="servers-container" class="row" style="display: none;">
    <!-- Server cards will be dynamically loaded here -->
</div>

<!-- No Servers State -->
<div id="no-servers" class="text-center py-5" style="display: none;">
    <i class="bi bi-server text-muted" style="font-size: 3rem;"></i>
    <h4 class="mt-3 text-muted">No MCP Servers Found</h4>
    <p class="text-muted">Install some MCP plugins to see their status here.</p>
    <a href="/mcp-hub" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add MCP Plugins
    </a>
</div>

<!-- Server Details Modal -->
<div class="modal fade" id="serverDetailsModal" tabindex="-1" aria-labelledby="serverDetailsModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serverDetailsModalLabel">Server Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="server-details-content">
                    <!-- Server details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let allServers = [];
let filteredServers = [];
let currentStatusFilter = 'all';
let wsConnection = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadServerStatus();
    connectWebSocket();
    
    // Auto-refresh every 30 seconds
    setInterval(loadServerStatus, 30000);
});

// WebSocket connection for real-time updates
function connectWebSocket() {
    const wsUrl = `ws://${window.location.host}/ws`;
    wsConnection = new WebSocket(wsUrl);
    
    wsConnection.onopen = function() {
        console.log('WebSocket connected for MCP status updates');
    };
    
    wsConnection.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'mcp_status_update') {
            updateServerStatus(data.server_id, data.status);
        } else if (data.type === 'mcp_metrics_update') {
            updateServerMetrics(data.server_id, data.metrics);
        }
    };
    
    wsConnection.onclose = function() {
        console.log('WebSocket disconnected, attempting to reconnect...');
        setTimeout(connectWebSocket, 5000);
    };
}

// Load server status from API
async function loadServerStatus() {
    try {
        showLoading(true);
        
        const response = await fetch('/api/mcp/status');
        const data = await response.json();
        
        if (data.success) {
            allServers = data.servers;
            filteredServers = [...allServers];
            displayServers();
            updateSummaryCards();
            showLoading(false);
        } else {
            throw new Error(data.error || 'Failed to load server status');
        }
    } catch (error) {
        console.error('Error loading server status:', error);
        showAlert('danger', `Error loading server status: ${error.message}`);
        showLoading(false);
        showNoServers();
    }
}

// Display servers in grid - NO FLASH TRANSITIONS
function displayServers() {
    const container = document.getElementById('servers-container');
    const noServers = document.getElementById('no-servers');

    if (filteredServers.length === 0) {
        // Smooth CSS-only transition to no-servers state
        container.classList.add('fade-out');
        noServers.classList.remove('fade-out');
        noServers.classList.add('fade-in');

        // Use transitionend event instead of setTimeout
        container.addEventListener('transitionend', function hideContainer() {
            container.classList.add('hidden');
            container.removeEventListener('transitionend', hideContainer);
        }, { once: true });

        noServers.classList.remove('hidden');
        return;
    }

    // Smooth CSS-only transition to servers display
    noServers.classList.add('fade-out');
    container.classList.remove('fade-out');
    container.classList.add('fade-in');

    // Use transitionend event instead of setTimeout
    noServers.addEventListener('transitionend', function hideNoServers() {
        noServers.classList.add('hidden');
        noServers.removeEventListener('transitionend', hideNoServers);
    }, { once: true });

    container.classList.remove('hidden');
    container.innerHTML = filteredServers.map(server => createServerCard(server)).join('');
}

// Create server card HTML
function createServerCard(server) {
    const statusClass = `status-${server.status}`;
    const uptimePercent = Math.min(100, (server.uptime / (24 * 60 * 60)) * 100); // 24h max

    // Mark dummy/mock data with asterisks
    const uptimeDisplay = server.uptime === 0 ? "Offline" : (server.uptime > 3600 && server.uptime < 90000 && server.tool_calls === 0 ? `${formatUptime(server.uptime)}*` : formatUptime(server.uptime));
    const responseTimeDisplay = server.response_time > 0 && server.tool_calls === 0 ? `${server.response_time}ms*` : `${server.response_time}ms`;
    const successRateDisplay = server.success_rate > 0 && server.tool_calls === 0 ? `${server.success_rate}%*` : `${server.success_rate}%`;

    return `
        <div class="col-lg-6 col-xl-4 mb-4 server-item" data-status="${server.status}">
            <div class="card status-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">${server.name}</h6>
                    <span class="server-status ${statusClass}">${server.status}</span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="metric-label">Uptime</div>
                            <div class="metric-value" style="font-size: 1rem;">${uptimeDisplay}</div>
                            <div class="uptime-indicator">
                                <div style="width: ${uptimePercent}%; height: 100%; background-color: #28a745; border-radius: 2px;"></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-label">Response Time</div>
                            <div class="metric-value" style="font-size: 1rem;">${responseTimeDisplay}</div>
                            <div class="response-time-chart" id="chart-${server.id}"></div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="metric-label">Tool Calls</div>
                            <div class="metric-value" style="font-size: 1rem;">${server.tool_calls}</div>
                        </div>
                        <div class="col-6">
                            <div class="metric-label">Success Rate</div>
                            <div class="metric-value" style="font-size: 1rem;">${successRateDisplay}</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="metric-label">Available Tools (${server.total_tools || server.tools.length})</div>
                        ${server.session_tools ? `
                        <div class="mt-1 mb-2">
                            <small class="text-muted">Active Sessions: ${server.active_sessions || 0}/${server.max_sessions || 0}</small>
                        </div>
                        ` : ''}
                        <div class="mt-2">
                            ${server.tools.map(tool => `<span class="tool-badge">${tool}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Last activity: ${formatLastActivity(server.last_activity)}</small>
                        <div class="btn-group btn-group-sm">
                            ${server.status === 'running' ? 
                                `<button class="btn btn-outline-warning" onclick="restartServer('${server.id}')">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="stopServer('${server.id}')">
                                    <i class="bi bi-stop"></i>
                                </button>` :
                                `<button class="btn btn-outline-success" onclick="startServer('${server.id}')">
                                    <i class="bi bi-play"></i>
                                </button>`
                            }
                            <button class="btn btn-outline-info" onclick="viewServerDetails('${server.id}')">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            ${server.id !== 'core' ? `
                                <button class="btn btn-outline-secondary" onclick="openSettings('${server.id}')">
                                    <i class="bi bi-gear"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Update summary cards
function updateSummaryCards() {
    const runningCount = allServers.filter(s => s.status === 'running').length;

    // Count unique tool types across all servers (not instances)
    const uniqueToolTypes = new Set();
    allServers.forEach(server => {
        if (server.unique_tool_types) {
            server.unique_tool_types.forEach(toolType => uniqueToolTypes.add(toolType));
        } else {
            // Fallback for servers without unique_tool_types
            server.tools.forEach(tool => {
                // Extract base tool type (remove _tool_1, _tool_2, etc.)
                const baseType = tool.replace(/_tool_\d+$/, '').replace(/-/g, '_');
                uniqueToolTypes.add(baseType);
            });
        }
    });

    const totalTools = uniqueToolTypes.size;
    const totalCalls = allServers.reduce((sum, s) => sum + (s.tool_calls || 0), 0);
    const avgResponse = Math.round(allServers.reduce((sum, s) => sum + (s.response_time || 0), 0) / allServers.length) || 0;

    document.getElementById('running-count').textContent = runningCount;
    document.getElementById('total-tools').textContent = totalTools;
    document.getElementById('total-calls').textContent = totalCalls.toLocaleString();
    document.getElementById('avg-response').textContent = avgResponse + 'ms';
}

// Utility functions
function formatUptime(seconds) {
    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
    return `${Math.floor(seconds / 86400)}d`;
}

function formatLastActivity(timestamp) {
    if (!timestamp) return 'Never';
    const now = new Date();
    const activity = new Date(timestamp);
    const diff = Math.floor((now - activity) / 1000);
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
}

function showLoading(show) {
    const loading = document.getElementById('loading-state');
    const container = document.getElementById('servers-container');
    const noServers = document.getElementById('no-servers');

    if (show) {
        // Show loading, hide others
        loading.classList.remove('hidden', 'fade-out');
        loading.classList.add('fade-in');
        container.classList.add('fade-out', 'hidden');
        noServers.classList.add('fade-out', 'hidden');
    } else {
        // Hide loading
        loading.classList.add('fade-out');
        loading.addEventListener('transitionend', function hideLoading() {
            loading.classList.add('hidden');
            loading.removeEventListener('transitionend', hideLoading);
        }, { once: true });
    }
}

function showNoServers() {
    const loading = document.getElementById('loading-state');
    const container = document.getElementById('servers-container');
    const noServers = document.getElementById('no-servers');

    loading.classList.add('fade-out', 'hidden');
    container.classList.add('fade-out', 'hidden');
    noServers.classList.remove('hidden', 'fade-out');
    noServers.classList.add('fade-in');
}

// Filter and sort functions
function filterServers() {
    const searchTerm = document.getElementById('server-search').value.toLowerCase();
    
    filteredServers = allServers.filter(server => {
        const matchesSearch = !searchTerm || 
            server.name.toLowerCase().includes(searchTerm) ||
            server.tools.some(tool => tool.toLowerCase().includes(searchTerm));
        
        const matchesStatus = currentStatusFilter === 'all' || server.status === currentStatusFilter;
        
        return matchesSearch && matchesStatus;
    });
    
    displayServers();
}

function filterByStatus(status) {
    currentStatusFilter = status;
    
    // Update active filter button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-status="${status}"]`).classList.add('active');
    
    filterServers();
}

function sortServers() {
    const sortBy = document.getElementById('sort-select').value;
    
    filteredServers.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'status':
                return a.status.localeCompare(b.status);
            case 'uptime':
                return b.uptime - a.uptime;
            case 'activity':
                return new Date(b.last_activity || 0) - new Date(a.last_activity || 0);
            case 'response_time':
                return a.response_time - b.response_time;
            default:
                return 0;
        }
    });
    
    displayServers();
}

// Server control functions
async function startServer(serverId) {
    try {
        const response = await fetch(`/api/mcp/servers/${serverId}/start`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', `Server started successfully`);
            loadServerStatus();
        } else {
            showAlert('danger', `Failed to start server: ${result.error}`);
        }
    } catch (error) {
        showAlert('danger', `Error starting server: ${error.message}`);
    }
}

async function stopServer(serverId) {
    if (!confirm('Are you sure you want to stop this server?')) return;
    
    try {
        const response = await fetch(`/api/mcp/servers/${serverId}/stop`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', `Server stopped successfully`);
            loadServerStatus();
        } else {
            showAlert('danger', `Failed to stop server: ${result.error}`);
        }
    } catch (error) {
        showAlert('danger', `Error stopping server: ${error.message}`);
    }
}

async function restartServer(serverId) {
    try {
        const response = await fetch(`/api/mcp/servers/${serverId}/restart`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', `Server restarted successfully`);
            loadServerStatus();
        } else {
            showAlert('danger', `Failed to restart server: ${result.error}`);
        }
    } catch (error) {
        showAlert('danger', `Error restarting server: ${error.message}`);
    }
}

function viewServerDetails(serverId) {
    const server = allServers.find(s => s.id === serverId);
    if (!server) {
        showAlert('danger', 'Server not found');
        return;
    }

    // Populate modal with server details
    document.getElementById('server-details-content').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h5>${server.name}</h5>
                <p class="text-muted">by ${server.author}</p>
                <p><strong>Status:</strong> <span class="badge bg-${server.status === 'running' ? 'success' : 'secondary'}">${server.status}</span></p>
                <p><strong>Version:</strong> ${server.version || 'N/A'}</p>
                <p><strong>Category:</strong> ${server.category}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Uptime:</strong> ${formatUptime(server.uptime)}</p>
                <p><strong>Response Time:</strong> ${server.response_time}ms</p>
                <p><strong>Tool Calls:</strong> ${server.tool_calls.toLocaleString()}</p>
                <p><strong>Success Rate:</strong> ${server.success_rate}%</p>
                <p><strong>Last Activity:</strong> ${formatLastActivity(server.last_activity)}</p>
            </div>
        </div>
        <hr>
        <h6>Available Tools (${server.total_tools || server.tools.length})</h6>
        ${server.session_details ? `
        <div class="mb-3">
            <h6 class="mt-3">Session Details</h6>
            ${Object.entries(server.session_details).map(([tool, sessions]) => `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small>${tool.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</small>
                    <span class="badge bg-${sessions.active > 0 ? 'success' : 'secondary'}">${sessions.active}/${sessions.max}</span>
                </div>
            `).join('')}
        </div>
        ` : ''}
        <div class="d-flex flex-wrap gap-1">
            ${server.tools.map(tool => `<span class="badge bg-secondary">${tool}</span>`).join('')}
        </div>
    `;

    // Show modal with proper cleanup and backdrop management
    const modalElement = document.getElementById('serverDetailsModal');
    const existingModal = bootstrap.Modal.getInstance(modalElement);

    // Dispose existing modal if it exists
    if (existingModal) {
        existingModal.dispose();
    }

    // Remove any existing backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.remove();
    });

    // Create and show new modal with explicit backdrop settings
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: 'static',  // Prevent backdrop click issues
        keyboard: true,
        focus: true
    });

    modal.show();

    // Add comprehensive cleanup on hide
    modalElement.addEventListener('hidden.bs.modal', function cleanupModal() {
        modal.dispose();

        // Force remove any remaining backdrops
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
            backdrop.remove();
        });

        // Reset body classes
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');

        // Remove this event listener
        modalElement.removeEventListener('hidden.bs.modal', cleanupModal);
    }, { once: true });
}

function formatUptime(seconds) {
    if (!seconds) return 'N/A';

    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);

    if (hours > 24) {
        const days = Math.floor(hours / 24);
        return `${days}d ${hours % 24}h`;
    } else if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else {
        return `${minutes}m`;
    }
}

function formatLastActivity(timestamp) {
    if (!timestamp) return 'N/A';

    const now = new Date();
    const activity = new Date(timestamp);
    const diffMs = now - activity;
    const diffMins = Math.floor(diffMs / 60000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;

    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}h ago`;

    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays}d ago`;
}

function openSettings(serverId) {
    window.location.href = `/mcp-settings/${serverId}`;
}

function refreshStatus() {
    loadServerStatus();
}

function exportMetrics() {
    // Export server metrics as CSV or JSON
    const data = allServers.map(server => ({
        name: server.name,
        status: server.status,
        uptime: server.uptime,
        response_time: server.response_time,
        tool_calls: server.tool_calls,
        success_rate: server.success_rate,
        tools_count: server.tools.length,
        last_activity: server.last_activity
    }));
    
    const csv = convertToCSV(data);
    downloadCSV(csv, 'mcp-server-metrics.csv');
}

function convertToCSV(data) {
    const headers = Object.keys(data[0]).join(',');
    const rows = data.map(row => Object.values(row).join(','));
    return [headers, ...rows].join('\n');
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}

function showAlert(type, message) {
    const alertContainer = document.getElementById('alert-container');
    const alertId = 'alert-' + Date.now();
    
    alertContainer.innerHTML = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
            bootstrap.Alert.getInstance(alert)?.close();
        }
    }, 5000);
}
</script>
{% endblock %}
